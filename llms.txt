# One Health VBD Hub (ohvbd)

## Introduction

`ohvbd` is an R package for retrieving (and parsing) data from a network
of disease vector data sources.

This package was developed as part of the [One Health Vector-Borne
Diseases Hub](https://vbdhub.org).

## Databases

`ohvbd` allows for searching and the retrieval of data from the
following data sources:

- [vbdhub](https://vbdhub.org) (search only)
- [VecTraits](https://vectorbyte.crc.nd.edu/vectraits-explorer)
- [VecDyn](https://vectorbyte.crc.nd.edu/vecdyn-datasets)
- [GBIF](https://www.gbif.org)
- [AreaData](https://pearselab.github.io/areadata/)

## Installation

You can install the stable version of ohvbd from CRAN:

``` r
install.packages("ohvbd")
```

You can alternatively install the development version of ohvbd from
[GitHub](https://github.com/fwimp/ohvbd) including any new or
experimental features:

``` r
# install.packages("devtools")
devtools::install_github("fwimp/ohvbd")
```

The vignettes are all available online, but if you would like to build
them locally, add `build_vignettes = TRUE` into your `install_github()`
command. However, we do not recommend doing this due to the number of
extra R packages utilised in the vignettes.

## Basic usage

`ohvbd` has been designed to make finding and retrieving data on disease
vectors simple and straightforward.

Typically it uses a “piped”-style approach to find, get, and filter data
from the supported databases, however it aims to provide the data to you
“as-is”, leaving further downstream analysis and filtering down to you.

A basic pipeline for finding and retrieving data on *Ixodes ricinus*
from the VecTraits database looks something like this:

``` r
library(ohvbd)

df <- search_hub("Ixodes ricinus") |>
  filter_db("vt") |>
  fetch() |>
  glean()
```

## Latest release patch notes

### ohvbd 1.0.0

**Major API change**

- `extract_` functions are now `glean_`.
  - This means that if `tidyverse` is loaded after `ohvbd`, there are no
    direct namespace collisions.

Full list of function name changes:

- [`extract()`](https://ohvbd.vbdhub.org/reference/extract.md) -\>
  [`glean()`](https://ohvbd.vbdhub.org/reference/glean.md)
- `extract_ad()` -\>
  [`glean_ad()`](https://ohvbd.vbdhub.org/reference/glean_ad.md)
- `extract_gbif()` -\>
  [`glean_gbif()`](https://ohvbd.vbdhub.org/reference/glean_gbif.md)
- `extract_vd()` -\>
  [`glean_vd()`](https://ohvbd.vbdhub.org/reference/glean_vd.md)
- `extract_vt()` -\>
  [`glean_vt()`](https://ohvbd.vbdhub.org/reference/glean_vt.md)
- `fetch_extract_vd_chunked()` -\>
  [`fetch_glean_vd_chunked()`](https://ohvbd.vbdhub.org/reference/fetch_glean_vd_chunked.md)
- `fetch_extract_vt_chunked()` -\>
  [`fetch_glean_vt_chunked()`](https://ohvbd.vbdhub.org/reference/fetch_glean_vt_chunked.md)

New functions & arguments:

- `ohvbd` now interfaces with GBIF for occurrence data.
  - New `*_gbif` functions
    (e.g. [`fetch_gbif()`](https://ohvbd.vbdhub.org/reference/fetch_gbif.md))
    allow for retrieving and extracting data from GBIF.
  - A GBIF account and the `rgbif` package are required to retrieve data
    from GBIF.
  - The account details must also be set up as shown in [the rgbif
    documentation](https://docs.ropensci.org/rgbif/articles/gbif_credentials.html).
- New [`tee()`](https://ohvbd.vbdhub.org/reference/tee.md) command
  allows one to extract data from the middle of a pipeline and save it
  to an environment.
  - This is definitely not only useful for `ohvbd` workflows, and can be
    used in any base R pipeline (`|>`). It has not been tested in
    magrittr pipelines but should work as-is.
- New [`filter_db()`](https://ohvbd.vbdhub.org/reference/filter_db.md)
  command allows for filtering out of only one database’s results from
  hub searches.
- [`check_db_status()`](https://ohvbd.vbdhub.org/reference/check_db_status.md)
  now returns (invisibly) whether all databases are up or not.
- New `fetch_citation()` and `fetch_citation_*` commands provide an
  interface to attempt to retrieve citations from a vectorbyte dataset.
  - This will (by default) possibly redownload parts or all of the data
    if the columns are not currently present.
- New [`force_db()`](https://ohvbd.vbdhub.org/reference/force_db.md)
  function enables one to force `ohvbd` to consider a particular object
  as having a particular provenance.
- New `simplify` argument to
  [`search_hub()`](https://ohvbd.vbdhub.org/reference/search_hub.md)
  makes hub searches return an `ohvbd.ids` object if only one database
  was searched for. This behaviour is on by default.
  - To match this,
    [`filter_db()`](https://ohvbd.vbdhub.org/reference/filter_db.md)
    will now transparently return `ohvbd.ids` objects if it gets them.
- New `taxonomy` argument to
  [`search_hub()`](https://ohvbd.vbdhub.org/reference/search_hub.md)
  allows for filtering searches by GBIF backbone IDs.
- New
  [`match_species()`](https://ohvbd.vbdhub.org/reference/match_species.md)
  function allows for quick and flexible matching of species names to
  their GBIF backbone IDs.
- New `match_country()` function allows for matching of country names to
  WKT polygons via naturalearth.
- New [`ohvbd_db()`](https://ohvbd.vbdhub.org/reference/ohvbd_db.md),
  [`has_db()`](https://ohvbd.vbdhub.org/reference/has_db.md), and
  [`is_from()`](https://ohvbd.vbdhub.org/reference/is_from.md) functions
  allow for quick testing of object provenance (according to `ohvbd`).
- New
  [`get_default_ohvbd_cache()`](https://ohvbd.vbdhub.org/reference/get_default_ohvbd_cache.md)
  function allows for custom functions that interface with cached
  `ohvbd` data files.
- New
  [`list_ohvbd_cache()`](https://ohvbd.vbdhub.org/reference/list_ohvbd_cache.md)
  and
  [`clean_ohvbd_cache()`](https://ohvbd.vbdhub.org/reference/clean_ohvbd_cache.md)
  functions enable better interactive cache management.
  - As a result,
    [`clean_ad_cache()`](https://ohvbd.vbdhub.org/reference/clean_ad_cache.md)
    has been removed as it is now unnecessary.
- `search_x_smart()` functions can now take `"tags"` as a search field,
  enabling support for tagged datasets.

Other:

- Entire code base is now continuously formatted using Air v0.7.1.
- Examples are no longer wrapped in `\dontrun{}` so they should be
  runnable from an installed version of the package.
- A good chunk of the functional logic of `ohvbd` is now covered with
  unit tests (using the `vcr` package).
- [`fetch_vd()`](https://ohvbd.vbdhub.org/reference/fetch_vd.md) no
  longer tries to retrieve ids with no pages of data.
- Functions that interface with vectorbyte databases no longer recommend
  using
  [`set_ohvbd_compat()`](https://ohvbd.vbdhub.org/reference/set_ohvbd_compat.md)
  as *unexpected* SSL errors **should** break pipelines by default.
  - These errors are no longer *expected* to occur when interfacing with
    vectorbyte.
- Running [`fetch()`](https://ohvbd.vbdhub.org/reference/fetch.md) on an
  `ohvbd.hub.search` or
  [`glean()`](https://ohvbd.vbdhub.org/reference/glean.md) on an
  `ohvbd.ids` object now provides a hint that you may have forgotten
  something.
  - Occasionally users would use forget a
    [`fetch()`](https://ohvbd.vbdhub.org/reference/fetch.md) command and
    run `search_hub() |> glean()` which didn’t previously give an
    interpretable error.
- Vignettes now use `vcr` to massively reduce their build time. This
  should only matter to developers of `ohvbd`, or users who download
  from github and build the vignettes themselves.
- [`ohvbd.ids()`](https://ohvbd.vbdhub.org/reference/ohvbd.ids.md) now
  warns you and fixes the problem if you provide ids with duplicate
  values.
- [`glean_vt()`](https://ohvbd.vbdhub.org/reference/glean_vt.md) and
  [`glean_vd()`](https://ohvbd.vbdhub.org/reference/glean_vd.md) now
  force the inclusion of the dataset ID when filtering columns (using
  the `cols` argument).
  - This is intended to encourage you to preserve at least one means of
    retrieving citation data later.
- WKT parsing and formatting is now significantly more robust.
- Cached AREAData now includes the cache timestamp as an attribute
  rather than a separate variable in the cache file.
- [`glean_ad()`](https://ohvbd.vbdhub.org/reference/glean_ad.md) now
  correctly returns a matrix even when there is only 1 row or column.
- gadm spatial files are now cached as GeoPackage rather than
  [shapefiles](http://switchfromshapefile.org/), leading to a \>50%
  speedup in loading! (Thanks to
  [@josiah.rs](https://bsky.app/profile/josiah.rs) on bluesky for the
  suggestion!)
- [`fetch_vd_counts()`](https://ohvbd.vbdhub.org/reference/fetch_vd_counts.md)
  is now significantly faster, more robust, and temporarily caches data.
  - You will see particular improvements if you are trying to retrieve
    more than about 10 ids in one go or if you are repeatedly running
    the same download code in the same day.
  - This speedup also applies to
    [`fetch_vd()`](https://ohvbd.vbdhub.org/reference/fetch_vd.md) under
    the hood, particularly if you are running it multiple times in a
    day.
- Explicit term checking (such as in
  [`fetch_ad()`](https://ohvbd.vbdhub.org/reference/fetch_ad.md) for
  metrics and
  [`search_vt_smart()`](https://ohvbd.vbdhub.org/reference/search_vt_smart.md)
  for operators and fields) is now fuzzy, allowing for a small amount of
  deviation from the actual term name.
- [`assoc_ad()`](https://ohvbd.vbdhub.org/reference/assoc_ad.md) now
  tries to guess LatLong column names if none (or the wrong ones) are
  provided.
- Errors in internal functions now make it more clear which user-facing
  functions they originate from.
- Multiple functions now default to `NULL` rather than `NA` for default
  missing values (except date arguments to AD-related functions, where
  NA is more reasonable in the grand scheme).
- [`fetch_ad()`](https://ohvbd.vbdhub.org/reference/fetch_ad.md) now
  caches and tries to read from cache by default.
  - Generally speaking unless exceedingly up-to-date data is required,
    this will be the best for most people.
  - If you *do* require guaranteed new data, it’s worth setting
    `refresh_cache = TRUE` or `use_cache = FALSE` (depending on if you
    want to replace your existing cache or not).
- All downloaders that can potentially cache data also attach the
  download time if not loading from cache.

See [changelog](https://ohvbd.vbdhub.org/news/index.html) for patch
notes for all versions.

# Package index

## Hub

Functions for interfacing with vbdhub.

- [`filter_db()`](https://ohvbd.vbdhub.org/reference/filter_db.md) :
  Filter hub search results by database
- [`search_hub()`](https://ohvbd.vbdhub.org/reference/search_hub.md) :
  Search vbdhub.org

## VecTraits

Functions for interfacing with VecTraits.

- [`fetch_citations_vt()`](https://ohvbd.vbdhub.org/reference/fetch_citations_vt.md)
  : Retrieve citations for vectraits data
- [`fetch_glean_vt_chunked()`](https://ohvbd.vbdhub.org/reference/fetch_glean_vt_chunked.md)
  : Get and parse multiple VecTraits datasets by ID in chunks
- [`fetch_vt()`](https://ohvbd.vbdhub.org/reference/fetch_vt.md) : Fetch
  VecTraits dataset/s by ID
- [`find_vt_ids()`](https://ohvbd.vbdhub.org/reference/find_vt_ids.md) :
  Get current IDs in VecTraits
- [`generate_vt_template()`](https://ohvbd.vbdhub.org/reference/generate_vt_template.md)
  : Generate a vectraits template from a short set of survey responses
- [`glean_vt()`](https://ohvbd.vbdhub.org/reference/glean_vt.md) : Parse
  data from requests to VecTraits
- [`search_vt()`](https://ohvbd.vbdhub.org/reference/search_vt.md) :
  Search VecTraits by keyword
- [`search_vt_smart()`](https://ohvbd.vbdhub.org/reference/search_vt_smart.md)
  : Search VecTraits using the explorer's filters

## VecDyn

Functions for interfacing with VecDyn.

- [`fetch_citations_vd()`](https://ohvbd.vbdhub.org/reference/fetch_citations_vd.md)
  : Retrieve citations for vecdyn data
- [`fetch_glean_vd_chunked()`](https://ohvbd.vbdhub.org/reference/fetch_glean_vd_chunked.md)
  : Fetch and parse multiple VecDyn datasets by ID in chunks
- [`fetch_vd()`](https://ohvbd.vbdhub.org/reference/fetch_vd.md) : Fetch
  VecDyn dataset/s by ID
- [`fetch_vd_counts()`](https://ohvbd.vbdhub.org/reference/fetch_vd_counts.md)
  : Fetch VecDyn dataset length by ID
- [`find_vd_columns()`](https://ohvbd.vbdhub.org/reference/find_vd_columns.md)
  : Get current columns in VecDyn datasets
- [`find_vd_ids()`](https://ohvbd.vbdhub.org/reference/find_vd_ids.md) :
  Get current IDs in VecDyn
- [`glean_vd()`](https://ohvbd.vbdhub.org/reference/glean_vd.md) : Parse
  data from requests to VecDyn
- [`search_vd()`](https://ohvbd.vbdhub.org/reference/search_vd.md) :
  Search VecDyn by keyword
- [`search_vd_smart()`](https://ohvbd.vbdhub.org/reference/search_vd_smart.md)
  : Search VecDyn using the explorer's filters

## GBIF

Functions for interfacing with GBIF.

- [`fetch_gbif()`](https://ohvbd.vbdhub.org/reference/fetch_gbif.md) :
  Fetch GBIF dataset/s by ID
- [`glean_gbif()`](https://ohvbd.vbdhub.org/reference/glean_gbif.md) :
  Parse data from requests to GBIF

## AREAdata

Functions for interfacing with AREAdata.

- [`assoc_ad()`](https://ohvbd.vbdhub.org/reference/assoc_ad.md) :
  Associate other data sources with AREAdata data
- [`fetch_ad()`](https://ohvbd.vbdhub.org/reference/fetch_ad.md) : Fetch
  AREAdata dataset
- [`fetch_gadm_sfs()`](https://ohvbd.vbdhub.org/reference/fetch_gadm_sfs.md)
  : Fetch gadm mapping shapefiles
- [`glean_ad()`](https://ohvbd.vbdhub.org/reference/glean_ad.md) :
  Extract data from AREAdata datasets

## Convenience

Convenient generalised functions for working with a range of data.

- [`fetch()`](https://ohvbd.vbdhub.org/reference/fetch.md) : Fetch
  specified data from a set of ids
- [`fetch_citations()`](https://ohvbd.vbdhub.org/reference/fetch_citations.md)
  : Try to find the relevant citations for a dataset
- [`force_db()`](https://ohvbd.vbdhub.org/reference/force_db.md) : Force
  an object to appear to come from a specific database
- [`glean()`](https://ohvbd.vbdhub.org/reference/glean.md) : Extract
  specified data from a set of responses
- [`has_db()`](https://ohvbd.vbdhub.org/reference/has_db.md) : Test
  whether an object has provenance information
- [`is_from()`](https://ohvbd.vbdhub.org/reference/is_from.md) : Test
  whether an object is considered to be from a particular database
- [`match_countries()`](https://ohvbd.vbdhub.org/reference/match_countries.md)
  : Match country names to their equivalent naturalearth WKT polygons
- [`match_species()`](https://ohvbd.vbdhub.org/reference/match_species.md)
  : Match species names to their GBIF backbone ids
- [`ohvbd_db()`](https://ohvbd.vbdhub.org/reference/ohvbd_db.md)
  [`` `ohvbd_db<-`() ``](https://ohvbd.vbdhub.org/reference/ohvbd_db.md)
  : Database provenance
- [`set_default_ohvbd_cache()`](https://ohvbd.vbdhub.org/reference/set_default_ohvbd_cache.md)
  : Set the default ohvbd cache location

## Deprecated

Functions that are deprecated and will be removed in future versions.

- [`clean_ad_cache()`](https://ohvbd.vbdhub.org/reference/clean_ad_cache.md)
  : Delete all rda files from ohvbd AREAdata cache (Deprecated)
- [`extract()`](https://ohvbd.vbdhub.org/reference/extract.md) : Extract
  specified data from a set of responses (Deprecated)

## Other

Miscellaneous functions.

- [`assoc_gadm()`](https://ohvbd.vbdhub.org/reference/assoc_gadm.md) :
  Associate other data sources with gadm IDs
- [`check_db_status()`](https://ohvbd.vbdhub.org/reference/check_db_status.md)
  : Check whether databases are currently online
- [`check_ohvbd_config()`](https://ohvbd.vbdhub.org/reference/check_ohvbd_config.md)
  : Print current ohvbd configuration variables
- [`clean_ohvbd_cache()`](https://ohvbd.vbdhub.org/reference/clean_ohvbd_cache.md)
  : Delete files from ohvbd cache directories
- [`fetch_vd_meta()`](https://ohvbd.vbdhub.org/reference/fetch_vd_meta.md)
  : Fetch VecDyn metadata table
- [`format_time_overlap_bar()`](https://ohvbd.vbdhub.org/reference/format_time_overlap_bar.md)
  : Format and print date overlaps
- [`get_default_ohvbd_cache()`](https://ohvbd.vbdhub.org/reference/get_default_ohvbd_cache.md)
  : Get ohvbd cache locations
- [`is_cached()`](https://ohvbd.vbdhub.org/reference/is_cached.md) :
  Check whether an object has been loaded from cache by ohvbd
- [`list_ohvbd_cache()`](https://ohvbd.vbdhub.org/reference/list_ohvbd_cache.md)
  : List all ohvbd cached files
- [`ohvbd.ids()`](https://ohvbd.vbdhub.org/reference/ohvbd.ids.md) :
  Create a new ohvbd ID vector
- [`ohvbd_attrs`](https://ohvbd.vbdhub.org/reference/ohvbd_attrs.md) :
  Internal attributes
- [`ohvbd_dryrun`](https://ohvbd.vbdhub.org/reference/ohvbd_dryrun.md) :
  Option: dry runs of ohvbd searches
- [`set_ohvbd_compat()`](https://ohvbd.vbdhub.org/reference/set_ohvbd_compat.md)
  : Set ohvbd compatability mode to TRUE
- [`tee()`](https://ohvbd.vbdhub.org/reference/tee.md) : Tee a pipeline
  to extract the data at a given point

### Base requests

Functions for modifying the basic targets of data API requests

- [`ad_basereq()`](https://ohvbd.vbdhub.org/reference/ad_basereq.md) :
  Generate a base request string for the AREAdata database
- [`vb_basereq()`](https://ohvbd.vbdhub.org/reference/vb_basereq.md) :
  Generate a base request object for the vectorbyte databases

# Articles

### All vignettes

- [Citing data retrieved using
  ohvbd](https://ohvbd.vbdhub.org/articles/citations.md):
- [Retrieving data from
  VectorByte](https://ohvbd.vbdhub.org/articles/retrieving-data.md):
- [Sourcing climatic data from
  AREAdata](https://ohvbd.vbdhub.org/articles/use-areadata.md):
