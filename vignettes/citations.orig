---
title: "Citing data retrieved using ohvbd"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Citing data retrieved using ohvbd}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r earlypkgload, include=FALSE}
library(ohvbd)
runstart <- lubridate::now()
```

```{r options, include=FALSE}
# Suppress cli output in non-interactive mode
if (!rlang::is_interactive()) {
  options(cli.default_handler = function(msg) invisible(NULL))
} else {
  options(cli.default_handler = NULL)
}
```

## Citations

Naturally, when performing scientific research, citation is an important part of the process. It is important that data generators (and curators) recieve appropriate citation for their work, upon which future work is based.

Often, however, the lifecycle of external data within a project can lead to times when data becomes somewhat divorced from its origins.

For example if a dataset was downloaded from a data source, then transformed and the minimal essential columns joined onto another dataset, it may no longer be straightforward to work out where the data originated.

## `ohvbd` citation tools

The `ohvbd` package provides certain tools to make it easier to derive the sources of data used in one's analysis, provided that certain columns are retained.

### A basic example

As a simple example, let's imagine that previously we downloaded data from vectraits with the following code:

```{r vt_pipeline_hub}
library(ohvbd)

df <- search_hub("Aedes aegypti") |>
  filter_db("vt") |>
  head(5) |>
  fetch() |>
  glean()
unique(df$DatasetID)
```
Given that we have not filtered any columns out, this dataset contains all the citation columns as-is.

As such we can simply extract these columns as is using the `fetch_citations()` function. This is by far the simplest scenario.

```{r extract_vt_citations_basic}
df |> fetch_citations()
```

If you look closely at the output, you should see that a couple of these datasets are derived from the same paper.

You may only want a list of all the citations present in your dataset, in which case the `minimise` argument to `fetch_citations()` can be used:

```{r extract_vt_citations_minimise}
df |> fetch_citations(minimise = TRUE)
```

### Missing columns

At some point during the download process, or during later steps, you may have filtered out some of the citation columns:

```{r vt_pipeline_hub_filter}
df2 <- search_hub("Aedes aegypti") |>
  filter_db("vt") |>
  head(5) |>
  fetch() |>
  glean(cols = c(
    "DatasetID",
    "Interactor1",
    "OriginalTraitName",
    "OriginalTraitValue"
    ))
head(df2)
```

Here we don't have the citation columns to hand, however because we have the *"DatasetID"* column intact, `ohvbd` can use this to retrieve the citations again!

```{r extract_vt_citations_missing, cassette="aedes_hub_pipeline"}
df2 |> fetch_citations(minimise = TRUE)
```

### Orphaned data

If you perform certain actions on your dataset (such as saving to and retrieving from a csv, or some data filtering processes) you may end up losing the attribute that internally tells `ohvbd` where the data came from.

For example, let's take a our `df` dataset and run the select function from dplyr on it:

```{r}
df_filtered <- df |>
  dplyr::select(c(
    "DatasetID",
    "Interactor1",
    "OriginalTraitName",
    "OriginalTraitValue"
    ))
head(df_filtered)
```

If we inspect the resultant object using the `has_db()` function, we can see that it has lost its database marker:

```{r}
has_db(df)
has_db(df_filtered)
```

There are a few ways we can clear this up.

The first option would be to just redownload the specific datasets as they were downloaded before:

```{r vt_recover_citations_missingdb}
ohvbd.ids(unique(df_filtered$DatasetID), "vt") |>
  fetch() |>
  glean() |>
  fetch_citations() |>
  head(5)
```

To make this easier, `fetch_citations()` will (grumblingly) accept an `ohvbd.ids` object:

```{r vt_recover_citations_missingdb_2}
ohvbd.ids(unique(df_filtered$DatasetID), "vt") |>
  fetch_citations() |>
  head(5)
```

#### Forcing the db

Alternatively, if you know the dataset is intact and has just lost its database tag, you can force-apply that tag again using the `force_db()` function!

```{r vt_recover_citations_missingdb_3}
df_filtered |>
  force_db("vt") |>
  fetch_citations() |>
  head(5)
```

### Missing Dataset IDs

Unfortunately if you also removed the Dataset ID column from your data at some point, it is very hard to easily retrieve the citations.

As such it is *highly recommended* that you build citation-retrieval into your initial data download pipeline in some form.

## Retrieving GBIF citations

Currently `fetch_citations()` does not directly support GBIF downloads, however `ohvbd` does provide a tool to help with using the `rgbif` citation retrieval mechanism.

To retrieve a citation from GBIF using rgbif you need to use the output of `fetch_gibf()`. If you are piping your commands together this can pose an issue as you need to retrieve the data from the middle of the pipeline for later use.

This is where the `tee()` command comes in handy.

It allows you intercept and extract the data from the the middle of a pipeline for later use. In this case let's extract the output of `fetch()` into a variable called "gbif_cite".

```{r tee_demo, echo=TRUE, eval=FALSE}
gbif_data <- search_hub("Ixodes", "gbif") |>
  head(1) |>
  fetch() |>
  tee("gbif_cite") |>
  glean()
```

Now, given that ``fetch_gbif()` returns a list, depending on the number of datasets returned we have multiple options on how to proceed.

For a single dataset (which will nearly always be the case) we can just access the first entry of the list by indexing:

```{r gbif_citation, echo=TRUE, eval=FALSE}
library(rgbif)

rgbif::gbif_citation(gbif_cite[[1]])
```

```
## $download
## [1] "GBIF Occurrence Download https://doi.org/10.15468/dl.6ubuz9 Accessed from R via rgbif (https://github.com/ropensci/rgbif) on 2025-10-27"
##
## $datasets
## list()
```

Alternatively to deal with multiple datasets, we would have to use lapply instead to run `gbif_citation()` on every entry:

```{r gbif_citation_alt, echo=TRUE, eval=FALSE}
lapply(gbif_cite, rgbif::gbif_citation)
```

```
## [[1]]
## [[1]]$download
## [1] "GBIF Occurrence Download https://doi.org/10.15468/dl.6ubuz9 Accessed from R via rgbif (https://github.com/ropensci/rgbif) on 2025-10-27"
##
## [[1]]$datasets
## list()
```

```{r tot_time, include=FALSE}
tot_time <- lubridate::as.duration(lubridate::now() - runstart)
```

<span style="opacity: 0.1;font-size: small;">Built in `r tot_time`s</span>
